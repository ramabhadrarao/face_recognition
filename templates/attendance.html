{% extends "base.html" %}

{% block title %}Attendance - Face Recognition{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="row align-items-center">
        <div class="col">
            <h2 class="page-title">Attendance System</h2>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Face Recognition</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="position-relative">
                                <video id="video" class="w-100" autoplay playsinline muted style="border-radius: 4px;"></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                                <div class="face-guide"></div>
                            </div>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col">
                                <button type="button" class="btn btn-success w-100" id="clockInBtn">
                                    <i class="ti ti-login"></i> Clock In
                                </button>
                            </div>
                            <div class="col">
                                <button type="button" class="btn btn-danger w-100" id="clockOutBtn">
                                    <i class="ti ti-logout"></i> Clock Out
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoMode">
                                <label class="form-check-label" for="autoMode">
                                    Auto-detect mode (recognizes automatically)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recognition Result</h3>
                    </div>
                    <div class="card-body">
                        <div id="results">
                            <div class="text-center text-muted">
                                <i class="ti ti-scan" style="font-size: 48px;"></i>
                                <p class="mt-3">Position your face in the camera and click Clock In or Clock Out</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Today's Logs</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table card-table table-vcenter">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Employee</th>
                                    <th>Type</th>
                                    <th>Match</th>
                                </tr>
                            </thead>
                            <tbody id="todayLogs">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        No logs for today
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const clockInBtn = document.getElementById('clockInBtn');
const clockOutBtn = document.getElementById('clockOutBtn');
const autoModeCheckbox = document.getElementById('autoMode');
const resultsDiv = document.getElementById('results');
const todayLogsBody = document.getElementById('todayLogs');

let stream = null;
let autoInterval = null;
let todayLogs = [];

// Start camera
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            },
            audio: false
        });
        
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
        };
    } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Could not access camera');
    }
}

// Clock function
async function clock(type) {
    if (!video.videoWidth || !video.videoHeight) {
        return;
    }
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.9);
    
    // Show loading
    resultsDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border"></div>
            <p class="mt-2">Processing...</p>
        </div>
    `;
    
    // Disable buttons
    clockInBtn.disabled = true;
    clockOutBtn.disabled = true;
    
    try {
        const response = await fetch('/api/clock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                image: imageData,
                type: type 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Success result
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h4 class="alert-title">
                        <i class="ti ti-check"></i> Clock ${type} Successful!
                    </h4>
                    <div class="text-muted">
                        <strong>Employee:</strong> ${data.employee.name}<br>
                        <strong>ID:</strong> ${data.employee.id}<br>
                        <strong>Department:</strong> ${data.employee.department}<br>
                        <strong>Time:</strong> ${data.timestamp}<br>
                        <strong>Confidence:</strong> ${data.similarity}
                    </div>
                </div>
            `;
            
            // Add to today's logs
            addToTodayLogs(data);
            
            // Play success sound (optional)
            playSound('success');
        } else {
            // Failed result
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h4 class="alert-title">
                        <i class="ti ti-alert-circle"></i> Recognition Failed
                    </h4>
                    <div class="text-muted">${data.message || 'Face not recognized'}</div>
                </div>
            `;
            
            playSound('error');
        }
    } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h4 class="alert-title">Error</h4>
                <div class="text-muted">Failed to process request</div>
            </div>
        `;
    } finally {
        // Re-enable buttons
        clockInBtn.disabled = false;
        clockOutBtn.disabled = false;
    }
}

// Add to today's logs display
function addToTodayLogs(data) {
    // Parse the timestamp and format it
    const timestamp = data.timestamp.replace(' IST', '');
    const date = new Date(timestamp);
    
    const row = `
        <tr>
            <td>${data.timestamp}</td>
            <td>${data.employee.name}</td>
            <td>
                <span class="badge bg-${data.log_type === 'IN' ? 'success' : 'danger'}">
                    ${data.log_type}
                </span>
            </td>
            <td>${data.similarity}</td>
        </tr>
    `;
    
    // Remove "no logs" message if present
    if (todayLogsBody.querySelector('.text-muted')) {
        todayLogsBody.innerHTML = '';
    }
    
    // Add new row at the top
    todayLogsBody.insertAdjacentHTML('afterbegin', row);
}

// Play sound feedback
function playSound(type) {
    const audio = new Audio();
    if (type === 'success') {
        // Success beep
        audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLdiTcIGWi77OScTgwLUK';
    } else {
        // Error beep
        audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAAAhICEiIx4jJCUlJiUnJygpKSkqKCknJSMhHx0aFxQPCgYAAQQJDRETGBwfISMmKS';
    }
    audio.play().catch(e => console.log('Audio play failed:', e));
}

// Event listeners
clockInBtn.addEventListener('click', () => clock('IN'));
clockOutBtn.addEventListener('click', () => clock('OUT'));

autoModeCheckbox.addEventListener('change', function() {
    if (this.checked) {
        autoInterval = setInterval(() => {
            // Auto-detect logic here
            // You could implement face detection and auto-trigger
        }, 3000);
    } else {
        clearInterval(autoInterval);
    }
});

// Load today's logs on page load
async function loadTodayLogs() {
    // This would fetch today's logs from the server
    // For now, we'll just use the logs added during this session
}

// Initialize
startCamera();
loadTodayLogs();

// Cleanup
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});
</script>

<style>
.face-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 250px;
    border: 2px dashed rgba(255,255,255,0.5);
    border-radius: 50%;
    pointer-events: none;
}

#video {
    background-color: #000;
    min-height: 300px;
}
</style>
{% endblock %}